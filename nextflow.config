/*
 * hpc-ont-lifecycle: Hybrid GCS-to-Slurm PromethION Data Workflow
 * Configuration for local HPC with Slurm scheduler
 */

params {
    // Input samplesheet (CSV) with runs to process
    samplesheet = null  // Required: path to CSV file

    // Default Dorado basecalling model (can be overridden per sample in samplesheet)
    dorado_model = "dna_r10.4.1_e8.2_400bps_hac@v4.3.0"

    // Local scratch directory for staging data
    scratch_dir = "/scratch/${USER}/ont-lifecycle"

    // Safety switch - must be explicitly set to true to delete raw data
    delete_raw = false

    // Include failed reads in processing
    include_fail = false
}

// Process-specific configuration
process {
    executor = 'slurm'

    // Default for lightweight tasks
    queue = 'standard'
    memory = '8 GB'
    time = '4h'

    withName: 'STAGE_DATA' {
        queue = 'transfer'
        cpus = 4
        memory = '16 GB'
        time = '12h'
        maxForks = 1  // Process one run at a time to manage scratch quota
    }

    withName: 'DORADO_BASECALL' {
        queue = 'gpu'
        clusterOptions = '--gres=gpu:1'
        containerOptions = '--nv'
        cpus = 16
        memory = '64 GB'
        time = '24h'
        container = 'docker://ontresearch/dorado:latest'
    }

    withName: 'TRANSACTIONAL_FINISH' {
        queue = 'transfer'
        cpus = 4
        memory = '16 GB'
        time = '12h'
    }
}

// Apptainer (Singularity) configuration
apptainer {
    enabled = true
    autoMounts = true
    runOptions = '--nv'  // Global GPU support for NVidia containers
}

// Environment variables passed to all jobs
env {
    GOOGLE_APPLICATION_CREDENTIALS = "${HOME}/.gcp/credentials.json"
}

// Profiles for different execution modes
profiles {
    slurm {
        process.executor = 'slurm'
    }

    local {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '16 GB'
    }

    test {
        params.samplesheet = "test/samplesheet.csv"
        params.delete_raw = false
    }
}

// Manifest
manifest {
    name = 'hpc-ont-lifecycle'
    author = 'HPC Team'
    description = 'Hybrid GCS-to-Slurm PromethION Data Workflow'
    version = '2.0.0'
    nextflowVersion = '>=23.04'
    mainScript = 'main.nf'
}

// Execution reports
report {
    enabled = true
    file = "${params.scratch_dir}/reports/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.scratch_dir}/reports/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.scratch_dir}/reports/trace.txt"
    overwrite = true
}
